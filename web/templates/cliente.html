<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Reservar - Hotel R&G</title>
    <style>
        /* ... ESTILOS OMITIDOS POR BREVEDAD ... */
        :root {
            --bg: #f6fbf8;
            --card: #fff;
            --accent: #3fbf7f;
            --muted: #6b7280;
            --danger: #ff6b6b
        }

        body {
            margin: 0;
            font-family: Inter, system-ui, Arial;
            background: var(--bg);
            color: #072018
        }

        .wrap {
            max-width: 980px;
            margin: 28px auto;
            padding: 18px
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 18px
        }

        .card {
            background: var(--card);
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 6px 22px rgba(7, 20, 20, 0.06);
            margin-bottom: 20px
        }

        .row {
            display: flex;
            gap: 12px
        }

        .col {
            flex: 1
        }

        h2 {
            margin: 0 0 12px 0
        }

        label {
            display: block;
            margin-bottom: 6px;
            color: var(--muted);
            font-size: 13px
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e9f0ec;
            margin-bottom: 10px
        }

        button {
            background: var(--accent);
            color: white;
            border: 0;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer
        }

        button.danger {
            background: var(--danger)
        }

        #available-rooms>div {
            padding: 10px;
            border: 1px solid #eef6f0;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        #available-rooms>div.selected {
            background: #e8f8ef;
            border-color: #3fbf7f;
        }
    </style>
</head>

<body>

    <div class="wrap">
        <header>
            <h1>Bienvenido(a) Cliente</h1>
            <button class="danger" onclick="logout()">Cerrar Sesión</button>
        </header>

        <div class="card">
            <h2>Crear Nueva Reserva</h2>
            <div class="row">
                <div class="col"><label for="checkin">Check-in</label><input type="date" id="checkin" required></div>
                <div class="col"><label for="checkout">Check-out</label><input type="date" id="checkout" required></div>
                <div class="col"><label for="type">Tipo Habitación</label>
                    <select id="type">
                        <option value="todos">Todos</option>
                        <option value="sencilla">Sencilla</option>
                        <option value="doble">Doble</option>
                        <option value="suite">Suite</option>
                    </select>
                </div>
            </div>
            <button onclick="searchRooms()">Buscar Disponibilidad</button>

            <div id="rooms-container" style="margin-top:20px;">
                <h3>Habitaciones Disponibles</h3>
                <div id="available-rooms"></div>
            </div>
        </div>

        <div class="card">
            <h2>Mis Reservas Anteriores y Futuras</h2>
            <div id="my-reservations-container">Cargando reservas...</div>
        </div>

    </div>

    <div id="reserveModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:100;">
        <div style="background:white; margin:10% auto; padding:20px; border-radius:10px; width:400px;">
            <h3>Confirmar Reserva</h3>
            <p>Habitación: <span id="res-room-num"></span> (<span id="res-room-price"></span>/noche)</p>
            <p>Fechas: <span id="res-checkin"></span> a <span id="res-checkout"></span></p>
            <label for="res-guest-name">Nombre del Huésped</label><input type="text" id="res-guest-name" required>
            <label for="res-guest-email">Email de Contacto</label><input type="email" id="res-guest-email" required>
            <button class="btn-action" onclick="confirmReservation()">Confirmar</button>
            <button class="btn-action btn-delete" onclick="closeModal('reserveModal')">Cancelar</button>
            <input type="hidden" id="res-room-id">
        </div>
    </div>

    <script>
        const userRole = localStorage.getItem('user_role');
        const clientId = localStorage.getItem('client_id');
        let currentRooms = []; // Para almacenar las habitaciones disponibles
        let selectedRoom = null;

        // --- FUNCIÓN AGREGADA: Para obtener la fecha de hoy en formato YYYY-MM-DD
        function getTodayDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // --- AUTORIZACIÓN Y LÓGICA DE INICIO ---
        function init() {
            if (userRole !== 'cliente' || !clientId) {
                alert('Acceso no autorizado. Inicie sesión como cliente.');
                window.location.href = './login.html';
                return;
            }

            // CAMBIO CLAVE: Establece el mínimo para Check-in como la fecha de hoy
            const today = getTodayDateString();
            document.getElementById('checkin').min = today;
            document.getElementById('checkin').value = today; // Opcional: precargar con la fecha de hoy
            document.getElementById('checkout').min = today;

            document.getElementById('available-rooms').innerHTML = '<div class="muted">Busca fechas para ver habitaciones.</div>';
            renderMyReservations();

            // Añadir un listener para actualizar el 'min' de checkout cuando checkin cambie
            document.getElementById('checkin').addEventListener('change', (e) => {
                // Asegura que checkout sea al menos el día siguiente a checkin
                const checkinDate = new Date(e.target.value);
                checkinDate.setDate(checkinDate.getDate() + 1); // El día siguiente
                const nextDayString = checkinDate.toISOString().split('T')[0];
                document.getElementById('checkout').min = nextDayString;

                // Si checkout es anterior o igual a checkin, lo resetea
                if (document.getElementById('checkout').value <= e.target.value) {
                    document.getElementById('checkout').value = nextDayString;
                }
            });

            // Inicializa 'min' para checkout un día después de hoy
            const todayDate = new Date();
            todayDate.setDate(todayDate.getDate() + 1);
            document.getElementById('checkout').min = todayDate.toISOString().split('T')[0];
            document.getElementById('checkout').value = todayDate.toISOString().split('T')[0];
        }

        async function renderMyReservations() {
            const el = document.getElementById('my-reservations-container');
            el.innerHTML = 'Cargando...';
            try {
                // Llama al endpoint de reservas con el filtro client_id
                const resp = await fetch(`/api/reservations?client_id=${clientId}`, { headers: { 'X-User-Role': userRole } });
                const data = await resp.json();

                if (!resp.ok) throw new Error(data.error || 'Error al cargar');

                el.innerHTML = '';
                if (data.length === 0) { el.innerHTML = '<div class="muted">No tienes reservas.</div>'; return; }

                data.forEach(r => {
                    const d = document.createElement('div');
                    d.style.padding = '10px'; d.style.borderBottom = '1px solid #eef6f0';
                    d.innerHTML = `
                <div style="display:flex;justify-content:space-between">
                    <div>
                        <div style="font-weight:700">${r.reservation_code} • Hab. ${r.room_num} (${r.room_type})</div>
                        <div class="muted">Check-in: ${r.checkin_date} → Check-out: ${r.checkout_date}</div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-weight:700">$${r.total}</div>
                        <div class="muted">${r.status}</div>
                        ${r.status === 'reservada' ? `<button class="danger" style="margin-top:5px; padding:5px 10px;" onclick="cancelReservation(${r.reservation_id})">Cancelar</button>` : ''}
                    </div>
                </div>
            `;
                    el.appendChild(d);
                });
            } catch (e) {
                console.error(e);
                el.innerHTML = '<div class="muted">Error al cargar tus reservas.</div>';
            }
        }

        // Lógica de búsqueda de habitaciones (simulada sin filtro real por disponibilidad)
        async function searchRooms() {
            const checkin = document.getElementById('checkin').value;
            const checkout = document.getElementById('checkout').value;
            const type = document.getElementById('type').value;

            // CAMBIO: Validación de fechas más estricta
            if (!checkin || !checkout || checkin >= checkout || checkin < getTodayDateString()) {
                alert('Asegúrate de seleccionar fechas de Check-in y Check-out válidas. Check-in debe ser hoy o posterior, y Check-out debe ser posterior a Check-in.');
                return;
            }

            const el = document.getElementById('available-rooms');
            el.innerHTML = 'Buscando...';
            selectedRoom = null;

            try {
                // Llama al endpoint de habitaciones (permiso de lectura para todos)
                const resp = await fetch('/api/rooms', { headers: { 'X-User-Role': userRole } });
                currentRooms = await resp.json();

                // Filtra por tipo y estado
                const filteredRooms = currentRooms.filter(r =>
                    r.status === 'disponible' &&
                    (type === 'todos' || r.room_type === type)
                );

                el.innerHTML = '';
                if (filteredRooms.length === 0) { el.innerHTML = '<div class="muted">No se encontraron habitaciones disponibles para este filtro.</div>'; return; }

                filteredRooms.forEach(r => {
                    const d = document.createElement('div');
                    d.dataset.roomId = r.room_id;
                    d.innerHTML = `
                <strong>Hab. ${r.room_num}</strong> (${r.room_type}, ${r.capacity} personas) - 
                $${r.price} por noche
            `;
                    d.onclick = () => selectRoom(r.room_id);
                    el.appendChild(d);
                });
            } catch (e) {
                el.innerHTML = '<div class="muted">Error al buscar habitaciones.</div>';
            }
        }

        function selectRoom(roomId) {
            document.querySelectorAll('#available-rooms > div').forEach(div => div.classList.remove('selected'));

            selectedRoom = currentRooms.find(r => r.room_id === roomId);
            if (!selectedRoom) return;

            document.querySelector(`[data-room-id="${roomId}"]`).classList.add('selected');

            // Abre el modal de confirmación
            document.getElementById('res-room-id').value = roomId;
            document.getElementById('res-room-num').textContent = selectedRoom.room_num;
            document.getElementById('res-room-price').textContent = `$${selectedRoom.price}`;
            document.getElementById('res-checkin').textContent = document.getElementById('checkin').value;
            document.getElementById('res-checkout').textContent = document.getElementById('checkout').value;

            document.getElementById('reserveModal').style.display = 'block';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        async function confirmReservation() {
            // ... (lógica de validación) ...
            const checkin = document.getElementById('checkin').value;
            const checkout = document.getElementById('checkout').value;

            // Validación adicional de fechas antes de enviar
            if (checkin < getTodayDateString()) {
                alert('No se pueden hacer reservas para fechas de Check-in anteriores a hoy.');
                return;
            }
            if (checkin >= checkout) {
                alert('La fecha de Check-out debe ser posterior a la fecha de Check-in.');
                return;
            }

            const roomId = document.getElementById('res-room-id').value;
            const guestName = document.getElementById('res-guest-name').value;
            const guestEmail = document.getElementById('res-guest-email').value;

            if (!guestName || !guestEmail) {
                alert('Completa los campos de nombre y email.');
                return;
            }

            const payload = {
                client_id: parseInt(clientId),
                room_id: parseInt(roomId),
                guest_name: guestName,
                guest_email: guestEmail,
                checkin_date: checkin,
                checkout_date: checkout,
            };

            try {
                const resp = await fetch('/api/reservations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Role': userRole
                    },
                    body: JSON.stringify(payload)
                });

                const j = await resp.json();
                if (resp.ok) {
                    alert(`Reserva ${j.reservation_id} creada. Total estimado: $${j.total_estimado}`);
                    closeModal('reserveModal');
                    renderMyReservations(); // Recargar
                } else {
                    alert('Error al crear la reserva: ' + (j.error || 'Error desconocido'));
                }
            } catch (e) {
                alert('Error de conexión.');
                console.error(e);
            }
        }

        async function cancelReservation(resId) {
            if (!confirm('¿Estás seguro de que quieres cancelar esta reserva?')) return;

            try {
                const resp = await fetch(`/api/reservations/${resId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Role': userRole
                    },
                    body: JSON.stringify({ status: 'cancelada' })
                });

                if (resp.ok) {
                    alert('Reserva cancelada exitosamente.');
                    renderMyReservations(); // Recargar
                } else {
                    const j = await resp.json();
                    alert('Error al cancelar: ' + (j.error || 'Error desconocido'));
                }
            } catch (e) {
                alert('Error de conexión.');
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = './login.html';
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>
