<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Hotel R&amp;G - Panel Administrativo</title>
    <style>
        :root {
            --bg: #f3f7f6;
            --card: #ffffff;
            --muted: #6b7280;
            --accent: #2f9e65;
            --accent-2: #e8f8ef;
            --danger: #ff6b6b;
            --shadow: 0 10px 30px rgba(10, 20, 20, 0.06);
            --sidebar-width: 250px;
            font-family: Inter, system-ui, Arial, sans-serif;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            background: var(--bg);
            color: #072018;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid #eee;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.02);
            overflow-y: auto;
        }

        .logo {
            font-size: 20px;
            font-weight: 800;
            color: var(--accent);
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item {
            padding: 12px 15px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--muted);
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover {
            background: var(--accent-2);
            color: var(--accent);
        }

        .nav-item.active {
            background: var(--accent);
            color: white;
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px
        }

        .stat-card {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--accent)
        }

        .stat-card h3 {
            margin: 0;
            font-size: 14px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px
        }

        .stat-card p {
            margin: 10px 0 0;
            font-size: 28px;
            font-weight: bold
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: var(--card);
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-header h2 {
            margin: 0;
            font-size: 20px;
        }

        /* TOOLBAR (Search + Pagination) */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .search-box {
            position: relative;
            width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 35px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 14px;
        }

        .search-box::before {
            content: "üîç";
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            opacity: 0.5;
        }

        .table-container {
            overflow-x: auto
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee
        }

        th {
            background: var(--accent-2);
            font-weight: 600;
            color: var(--accent);
        }

        tr:hover {
            background: #f9f9f9;
        }

        .btn-action {
            background: var(--accent);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 13px;
            transition: 0.2s;
        }

        .btn-action:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-delete {
            background: var(--danger)
        }

        .btn-add {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-disabled-visual {
            background: var(--muted) !important;
            cursor: not-allowed !important;
            opacity: 0.7;
        }

        /* PAGINATION */
        .pagination {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pagination button {
            background: white;
            border: 1px solid #ddd;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination span {
            font-size: 14px;
            color: var(--muted);
        }

        /* MODAL STYLES */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 16px;
            width: 500px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content input,
        .modal-content select,
        .modal-content textarea {
            width: 100%;
            padding: 12px;
            margin: 8px 0 20px 0;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: inherit;
        }

        .modal-content label {
            font-weight: 500;
            font-size: 14px;
            color: var(--muted);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>

<body>

    <nav class="sidebar">
        <div class="logo">üè® Hotel R&amp;G</div>
        <div class="nav-item active" onclick="switchTab('dashboard')">üìä Dashboard</div>
        <div class="nav-item" onclick="switchTab('reservations')">üìÖ Gesti√≥n de Reservas</div>
        <div class="nav-item" onclick="switchTab('service-reservations')">üíÜ Reservas de Servicios</div>
        <div class="nav-item" onclick="switchTab('clients')">üë• Clientes</div>
        <div class="nav-item" onclick="switchTab('rooms')">üõèÔ∏è Habitaciones</div>
        <div class="nav-item" onclick="switchTab('services')">üíÜ Servicios</div>
        <div class="nav-item" onclick="switchTab('staff')" id="nav-staff">üë• Empleados</div>
        <div class="nav-item" onclick="switchTab('invoices')">üí∞ Facturaci√≥n</div>
        <div style="flex:1"></div>
        <div class="nav-item" style="color: var(--danger);" onclick="logout()">üö™ Cerrar Sesi√≥n</div>
    </nav>

    <main class="main-content">
        <header>
            <h1 id="page-title">Dashboard General</h1>
            <div style="display:flex; align-items:center; gap:10px;">
                <span
                    style="background:white; padding:5px 15px; border-radius:20px; font-size:14px; border:1px solid #eee;">
                    üë§ <span id="user-role-display">Rol</span>
                </span>
                <button onclick="logout()"
                    style="background:var(--danger); color:white; border:none; padding:8px 15px; border-radius:20px; cursor:pointer; font-size:12px; font-weight:bold;">
                    üö™ Salir
                </button>
            </div>
        </header>

        <!-- DASHBOARD SECTION -->
        <div id="dashboard-section" class="section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Reservas Activas</h3>
                    <p id="active-count">0</p>
                </div>
                <div class="stat-card">
                    <h3>Ocupaci√≥n</h3>
                    <p id="ocupacion">0%</p>
                </div>
                <div class="stat-card">
                    <h3>Ingresos (Total)</h3>
                    <p id="ingresos">$0</p>
                </div>
                <div class="stat-card">
                    <h3>Total Clientes</h3>
                    <p id="clients-count">0</p>
                </div>
                <!-- NUEVAS TARJETAS -->
                <div class="stat-card">
                    <h3>Total Habitaciones</h3>
                    <p id="total-rooms">0</p>
                </div>
                <div class="stat-card" style="border-left: 4px solid var(--danger);">
                    <h3>En Mantenimiento</h3>
                    <p id="maintenance-rooms">0</p>
                </div>
                <div class="stat-card" style="border-left: 4px solid var(--accent);">
                    <h3>Disponibles</h3>
                    <p id="available-rooms">0</p>
                </div>
                <div class="stat-card" style="border-left: 4px solid orange;">
                    <h3>Ocupadas</h3>
                    <p id="occupied-rooms">0</p>
                </div>
            </div>
        </div>

        <!-- CLIENTS SECTION -->
        <div id="clients-section" class="section">
            <div class="card">
                <div class="card-header">
                    <h2>Gesti√≥n de Clientes</h2>
                    <button class="btn-add" onclick="openClientModal('create')">‚ûï Nuevo Cliente</button>
                </div>
                <div class="toolbar">
                    <div class="search-box">
                        <input type="text" placeholder="Buscar por nombre, email..."
                            onkeyup="debounceSearch('clients', this.value)">
                    </div>
                    <div class="pagination" id="clients-pagination">
                        <!-- Controls injected by JS -->
                    </div>
                </div>
                <div class="table-container">
                    <table id="clients-table"></table>
                </div>
            </div>
        </div>

        <!-- ROOMS SECTION -->
        <div id="rooms-section" class="section">
            <div class="card">
                <div class="card-header">
                    <h2>Gesti√≥n de Habitaciones</h2>
                    <button class="btn-add" onclick="openRoomModal('create')">‚ûï Nueva Habitaci√≥n</button>
                </div>
                <div class="toolbar">
                    <div class="search-box">
                        <input type="text" placeholder="Buscar por n√∫mero, tipo..."
                            onkeyup="debounceSearch('rooms', this.value)">
                    </div>
                    <div class="pagination" id="rooms-pagination"></div>
                </div>
                <div class="table-container">
                    <table id="rooms-table"></table>
                </div>
            </div>
        </div>

        <!-- RESERVATIONS SECTION -->
        <div id="reservations-section" class="section">
            <div class="card">
                <div class="card-header">
                    <h2>Gesti√≥n de Reservas</h2>
                    <button class="btn-add" onclick="openReservationModal('create')">‚ûï Nueva Reserva</button>
                </div>
                <div class="toolbar">
                    <div class="search-box">
                        <input type="text" placeholder="Buscar por c√≥digo, cliente..."
                            onkeyup="debounceSearch('reservations', this.value)">
                    </div>
                    <div class="pagination" id="reservations-pagination"></div>
                </div>
                <div class="table-container">
                    <table id="reservations-table"></table>
                </div>
            </div>
        </div>

        <!-- SERVICE RESERVATIONS SECTION (NEW) -->
        <div id="service-reservations-section" class="section">
            <div class="card">
                <div class="card-header">
                    <h2>Reservas de Servicios</h2>
                    <button class="btn-add" onclick="openServiceReservationModal()">‚ûï Agendar Servicio</button>
                </div>
                <div class="table-container">
                    <div class="toolbar">
                        <div class="search-box">
                            <input type="text" placeholder="Buscar por cliente, servicio, habitaci√≥n..."
                                onkeyup="debounceSearch('reservation_services', this.value)">
                        </div>
                        <div class="pagination" id="reservation_services-pagination"></div>
                    </div>
                    <table id="reservation_services-table"></table>
                </div>
            </div>
        </div>

        <!-- STAFF SECTION -->
        <div id="staff-section" class="section">
            <div class="card">
                <div class="card-header">
                    <h2>Gesti√≥n de Empleados</h2>
                    <button class="btn-add" onclick="openStaffModal('create')">‚ûï Nuevo Empleado</button>
                </div>
                <div class="toolbar">
                    <div class="search-box">
                        <input type="text" placeholder="Buscar por nombre, rol..."
                            onkeyup="debounceSearch('staff', this.value)">
                    </div>
                    <div class="pagination" id="staff-pagination"></div>
                </div>
                <div class="table-container">
                    <table id="staff-table"></table>
                </div>
            </div>
        </div>

        <!-- SERVICES SECTION -->
        <div id="services-section" class="section">
            <div class="card">
                <div class="card-header">
                    <h2>Administraci√≥n de Servicios</h2>
                    <button class="btn-add" onclick="openServiceModal('create')" id="btn-add-service">‚ûï Nuevo
                        Servicio</button>
                </div>
                <div class="toolbar">
                    <div class="search-box">
                        <input type="text" placeholder="Buscar por nombre, c√≥digo..."
                            onkeyup="debounceSearch('services', this.value)">
                    </div>
                    <div class="pagination" id="services-pagination"></div>
                </div>
                <div class="table-container">
                    <table id="services-table"></table>
                </div>
            </div>
        </div>

        <!-- INVOICES SECTION -->
        <div id="invoices-section" class="section">
            <div class="card">
                <div class="card-header">
                    <h2>Facturaci√≥n</h2>
                    <button class="btn-add" onclick="openInvoiceModal('create')" id="btn-add-invoice">‚ûï Nueva
                        Factura</button>
                </div>
                <div class="toolbar">
                    <div class="search-box">
                        <input type="text" placeholder="Buscar por ID..."
                            onkeyup="debounceSearch('invoices', this.value)">
                    </div>
                    <div class="pagination" id="invoices-pagination"></div>
                </div>
                <div class="table-container">
                    <table id="invoices-table"></table>
                </div>
            </div>
        </div>

    </main>

    <div id="clientModal" class="modal">
        <div class="modal-content">
            <h3><span id="client-modal-title">Crear</span> Cliente</h3>
            <input type="hidden" id="client-id">
            <label for="client-name">Nombre Completo</label><input type="text" id="client-name" required>
            <label for="client-email">Email</label><input type="email" id="client-email"
                placeholder="ejemplo@correo.com">
            <label for="client-phone">Tel√©fono</label><input type="tel" id="client-phone" pattern="[0-9]+"
                oninput="this.value = this.value.replace(/[^0-9]/g, '')" placeholder="Solo n√∫meros">
            <label for="client-address">Direcci√≥n</label><input type="text" id="client-address">
            <button class="btn-action" onclick="saveClient()">Guardar</button>
            <button class="btn-action btn-delete" onclick="closeModal('clientModal')">Cancelar</button>
        </div>
    </div>

    <div id="roomModal" class="modal">
        <div class="modal-content">
            <h3><span id="room-modal-title">Crear</span> Habitaci√≥n</h3>
            <input type="hidden" id="room-id">
            <label for="room-num">N√∫mero de Habitaci√≥n</label><input type="number" id="room-num" required>
            <label for="room-type">Tipo</label>
            <select id="room-type">
                <option value="sencilla">Sencilla</option>
                <option value="doble">Doble</option>
                <option value="suite">Suite</option>
            </select>
            <label for="room-capacity">Capacidad</label><input type="number" id="room-capacity" required>
            <label for="room-price">Tarifa ($)</label><input type="number" id="room-price" step="0.01" required>
            <label for="room-status">Estado</label>
            <select id="room-status">
                <option value="disponible">Disponible</option>
                <option value="ocupada">Ocupada</option>
                <option value="mantenimiento">Mantenimiento</option>
            </select>
            <button class="btn-action" onclick="saveRoom()">Guardar</button>
            <button class="btn-action btn-delete" onclick="closeModal('roomModal')">Cancelar</button>
        </div>
    </div>

    <div id="staffModal" class="modal">
        <div class="modal-content">
            <h3><span id="staff-modal-title">Crear</span> Empleado</h3>
            <input type="hidden" id="staff-id">
            <label for="staff-name">Nombre Completo</label><input type="text" id="staff-name" required>
            <label for="staff-role-input">Rol</label>
            <select id="staff-role-input">
                <option value="admin">Admin</option>
                <option value="recepcion">Recepci√≥n</option>
                <option value="limpieza">Limpieza</option>
                <option value="mantenimiento">Mantenimiento</option>
            </select>
            <label for="staff-area">√Årea</label><input type="text" id="staff-area">
            <label for="staff-hire-date">Fecha de Contrataci√≥n</label><input type="date" id="staff-hire-date" required>
            <label for="staff-active">Activo</label>
            <select id="staff-active">
                <option value="1">S√≠</option>
                <option value="0">No</option>
            </select>
            <button class="btn-action" onclick="saveStaff()">Guardar</button>
            <button class="btn-action btn-delete" onclick="closeModal('staffModal')">Cancelar</button>
        </div>
    </div>

    <div id="serviceModal" class="modal">
        <div class="modal-content">
            <h3><span id="service-modal-title">Crear</span> Servicio</h3>
            <input type="hidden" id="service-id">
            <label for="service-code">C√≥digo (ej. S-1)</label><input type="text" id="service-code" required>
            <label for="service-name">Nombre</label><input type="text" id="service-name" required>
            <label for="service-price">Precio ($)</label><input type="number" id="service-price" step="0.01" required>
            <label for="service-description">Descripci√≥n</label><textarea id="service-description"></textarea>
            <button class="btn-action" onclick="saveService()">Guardar</button>
            <button class="btn-action btn-delete" onclick="closeModal('serviceModal')">Cancelar</button>
        </div>
    </div>

    <div id="reservationModal" class="modal">
        <div class="modal-content">
            <h3><span id="reservation-modal-title">Crear</span> Reserva</h3>
            <input type="hidden" id="reservation-id">
            <div class="form-group">
                <label>Cliente</label>
                <!-- Autocomplete Wrapper -->
                <div class="autocomplete-wrapper">
                    <input type="text" id="res-client-search" class="form-control" placeholder="Buscar cliente..."
                        autocomplete="off">
                    <input type="hidden" id="res-client-select">
                    <div id="res-client-results" class="autocomplete-results"></div>
                </div>
            </div>
            <div class="form-group">
                <label>Habitaci√≥n</label>
                <!-- Autocomplete Wrapper -->
                <div class="autocomplete-wrapper">
                    <input type="text" id="res-room-search" class="form-control" placeholder="Buscar habitaci√≥n..."
                        autocomplete="off">
                    <input type="hidden" id="res-room-select">
                    <div id="res-room-results" class="autocomplete-results"></div>
                </div>
            </div>
            <label for="res-checkin">Check-in</label><input type="date" id="res-checkin" required>
            <label for="res-checkout">Check-out</label><input type="date" id="res-checkout" required>
            <label for="res-total">Total Estimado ($)</label><input type="number" id="res-total" step="0.01"
                value="0.00" readonly required>
            <label for="res-status-new">Estado</label>
            <select id="res-status-new">
                <option value="reservada">Reservada</option>
                <option value="confirmada">Confirmada</option>
                <option value="checkin">Check-in</option>
                <option value="checkout">Check-out</option>
                <option value="cancelada">Cancelada</option>
                <option value="facturada">Facturada</option>
            </select>
            <button class="btn-action" onclick="saveReservation()">Guardar</button>
            <button class="btn-action btn-delete" onclick="closeModal('reservationModal')">Cancelar</button>
        </div>
    </div>

    <div id="reservationEditModal" class="modal">
        <div class="modal-content">
            <h3>Gesti√≥n de Reserva <span id="res-edit-code"></span></h3>
            <input type="hidden" id="res-edit-id">

            <button class="btn-action" style="float: right; margin-bottom: 10px;"
                onclick="openReservationModal('edit', document.getElementById('res-edit-id').value)">Editar Datos
                Principales</button>
            <div style="clear: both;"></div>

            <label for="res-status-input">Cambiar Estado</label>
            <select id="res-status-input">
                <option value="reservada">Reservada</option>
                <option value="confirmada">Confirmada</option>
                <option value="checkin">Check-in</option>
                <option value="checkout">Check-out</option>
                <option value="cancelada">Cancelada</option>
                <option value="facturada">Facturada</option>
            </select>
            <p id="res-status-message" style="color:var(--muted); font-size:12px;">El cambio de estado puede actualizar
                la disponibilidad de la habitaci√≥n.</p>
            <button class="btn-action" onclick="saveReservationStatus()">Actualizar Estado</button>

            <hr style="margin: 15px 0;">

            <div id="add-service-section">
                <h4>A√±adir Servicio</h4>
                <label for="res-service-select">Servicio</label>
                <select id="res-service-select"></select>
                <label for="res-service-quantity">Cantidad</label>
                <input type="number" id="res-service-quantity" value="1" min="1">
                <button class="btn-action" onclick="addServiceToReservation()">A√±adir</button>
            </div>

            <button class="btn-action btn-delete" onclick="closeModal('reservationEditModal')">Cerrar</button>
        </div>
    </div>

    <div id="invoiceModal" class="modal">
        <div class="modal-content">
            <h3><span id="invoice-modal-title">Crear</span> Factura</h3>
            <input type="hidden" id="invoice-id">

            <label for="invoice-res-select">Reserva Relacionada</label>
            <select id="invoice-res-select" required></select> <label for="invoice-total">Total Facturado
                ($)</label><input type="number" id="invoice-total" step="0.01" required>
            <label for="invoice-method">M√©todo de Pago</label>
            <select id="invoice-method">
                <option value="efectivo">Efectivo</option>
                <option value="tarjeta">Tarjeta</option>
                <option value="transferencia">Transferencia</option>
            </select>
            <label for="invoice-date">Fecha de Factura</label><input type="date" id="invoice-date" required>

            <button class="btn-action" onclick="saveInvoice()">Guardar</button>
            <button class="btn-action btn-delete" onclick="closeModal('invoiceModal')">Cancelar</button>
        </div>
    </div>


    <!-- MODAL RESERVA DE SERVICIOS (NUEVO) -->
    <div id="serviceReservationModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('serviceReservationModal')">&times;</span>
            <h2>Agendar Servicio</h2>

            <div class="form-group">
                <label>Cliente</label>
                <!-- Autocomplete Wrapper -->
                <div class="autocomplete-wrapper">
                    <input type="text" id="srv-res-client-search" class="form-control" placeholder="Buscar cliente..."
                        autocomplete="off">
                    <input type="hidden" id="srv-res-client">
                    <div id="srv-res-client-results" class="autocomplete-results"></div>
                </div>
            </div>

            <div class="form-group">
                <label>Reserva Activa</label>
                <select id="srv-res-id" class="form-control" disabled>
                    <option value="">Seleccione un cliente primero</option>
                </select>
                <small style="color: var(--muted);">Solo se muestran reservas activas (Check-in, Confirmada).</small>
            </div>

            <div class="form-group">
                <label>Servicio</label>
                <!-- Autocomplete Wrapper -->
                <div class="autocomplete-wrapper">
                    <input type="text" id="srv-res-service-search" class="form-control" placeholder="Buscar servicio..."
                        autocomplete="off">
                    <input type="hidden" id="srv-res-service">
                    <div id="srv-res-service-results" class="autocomplete-results"></div>
                    <div id="srv-res-service-results" class="autocomplete-results"></div>
                </div>
            </div>

            <div class="form-group">
                <label>Fecha del Servicio</label>
                <input type="date" id="srv-res-date" class="form-control">
                <small id="srv-date-hint" style="color: var(--muted);"></small>
            </div>

            <div class="form-group">
                <label>Cantidad</label>
                <input type="number" id="srv-res-qty" class="form-control" value="1" min="1">
            </div>

            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('serviceReservationModal')">Cancelar</button>
                <button class="btn-save" onclick="submitServiceReservation()">Agendar</button>
            </div>
        </div>
    </div>

    <!-- MODAL EDITAR RESERVA DE SERVICIO (NUEVO) -->
    <div id="serviceReservationEditModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('serviceReservationEditModal')">&times;</span>
            <h2>Editar Servicio Agendado</h2>
            <input type="hidden" id="edit-srv-res-id">

            <p><strong>Servicio:</strong> <span id="edit-srv-name"></span></p>
            <p><strong>Reserva:</strong> <span id="edit-srv-res-code"></span></p>

            <div class="form-group">
                <label>Fecha del Servicio</label>
                <input type="date" id="edit-srv-date" class="form-control">
            </div>

            <div class="form-group">
                <label>Cantidad</label>
                <input type="number" id="edit-srv-qty" class="form-control" min="1">
            </div>

            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('serviceReservationEditModal')">Cancelar</button>
                <button class="btn-save" onclick="updateServiceReservation()">Actualizar</button>
            </div>
        </div>
    </div>

    <script>
        const userRole = localStorage.getItem('user_role');
        const allowedRoles = ['admin', 'recepcion'];

        // Estado global para paginaci√≥n y b√∫squeda
        const state = {
            clients: { page: 1, search: '', perPage: 10 },
            rooms: { page: 1, search: '', perPage: 10 },
            staff: { page: 1, search: '', perPage: 10 },
            services: { page: 1, search: '', perPage: 10 },
            reservations: { page: 1, search: '', perPage: 10 },
            invoices: { page: 1, search: '', perPage: 10 },
            reservation_services: { page: 1, search: '', perPage: 10 }
        };

        let debounceTimer;

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function logout() {
            localStorage.clear();
            window.location.href = './login.html';
        }

        // --- TABS LOGIC ---
        function switchTab(tabName) {
            // 1. Update Sidebar
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Find the nav item that calls this function (approximate) or just rely on click handler adding class if we passed 'this'
            // For simplicity, we'll just iterate based on text or add IDs to nav items in future. 
            // Here we will just highlight based on index or simple logic if we had IDs.
            // Let's assume the user clicks and we update visual state there.
            // Better: Add IDs to nav items. For now, let's just show the section.

            // 2. Show Section
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));

            const sectionId = tabName === 'dashboard' ? 'dashboard-section' : `${tabName}-section`;
            const section = document.getElementById(sectionId);
            if (section) section.classList.add('active');

            // 3. Update Title
            const titles = {
                'dashboard': 'Dashboard General',
                'reservations': 'Gesti√≥n de Reservas',
                'service-reservations': 'Reservas de Servicios',
                'clients': 'Gesti√≥n de Clientes',
                'rooms': 'Gesti√≥n de Habitaciones',
                'services': 'Administraci√≥n de Servicios',
                'staff': 'Gesti√≥n de Empleados',
                'invoices': 'Facturaci√≥n'
            };
            document.getElementById('page-title').textContent = titles[tabName] || 'Panel';

            // 4. Load Data if needed
            if (tabName === 'clients') renderClients();
            if (tabName === 'rooms') renderRooms();
            if (tabName === 'staff') renderStaff();
            if (tabName === 'services') renderServices();
            if (tabName === 'reservations') renderReservations();
            if (tabName === 'invoices') renderInvoices();
            if (tabName === 'service-reservations') renderReservationServices();
            if (tabName === 'dashboard') updateDashboardMetrics();
        }

        // Add click event listener to nav items to handle active class
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function () {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // --- SEARCH & PAGINATION LOGIC ---
        function debounceSearch(entity, value) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                state[entity].search = value;
                state[entity].page = 1; // Reset to first page on new search
                refreshEntity(entity);
            }, 300);
        }

        function changePage(entity, delta) {
            state[entity].page += delta;
            refreshEntity(entity);
        }

        function refreshEntity(entity) {
            if (entity === 'clients') renderClients();
            if (entity === 'rooms') renderRooms();
            if (entity === 'staff') renderStaff();
            if (entity === 'services') renderServices();
            if (entity === 'reservations') renderReservations();
            if (entity === 'invoices') renderInvoices();
            if (entity === 'reservation_services') renderReservationServices();
        }

        function renderPaginationControls(entity, data) {
            const container = document.getElementById(`${entity}-pagination`);
            if (!container) return;

            const totalPages = data.pages || 1;
            const currentPage = state[entity].page;

            container.innerHTML = `
                <button onclick="changePage('${entity}', -1)" ${currentPage <= 1 ? 'disabled' : ''}>&lt;</button>
                <span>${currentPage} / ${totalPages}</span>
                <button onclick="changePage('${entity}', 1)" ${currentPage >= totalPages ? 'disabled' : ''}>&gt;</button>
            `;
        }

        // --- UTILIDADES ---
        async function fetchWithAuth(url, options = {}) {
            const defaultOptions = {
                headers: { 'X-User-Role': userRole }
            };
            const mergedOptions = { ...defaultOptions, ...options };
            if (options.headers) {
                mergedOptions.headers = { ...defaultOptions.headers, ...options.headers };
            }
            const resp = await fetch(url, mergedOptions);
            if (resp.status === 403) {
                alert('Acceso denegado. Tu rol no tiene permiso para esta acci√≥n.');
                throw new Error('Forbidden');
            }
            return resp;
        }


        // ====================================================================
        // GESTI√ìN DE CLIENTES (CRUD COMPLETO - FALTANTE)
        // ====================================================================

        function openClientModal(mode, clientId = null) {
            const modal = document.getElementById('clientModal');
            document.getElementById('client-modal-title').textContent = mode === 'create' ? 'Crear' : 'Editar';

            // Resetear campos
            document.getElementById('client-id').value = '';
            document.getElementById('client-name').value = '';
            document.getElementById('client-email').value = '';
            document.getElementById('client-phone').value = '';
            document.getElementById('client-address').value = '';

            if (mode === 'edit' && clientId) {
                const client = currentClientsData.find(c => c.client_id === clientId);
                if (client) {
                    document.getElementById('client-id').value = client.client_id;
                    document.getElementById('client-name').value = client.full_name;
                    document.getElementById('client-email').value = client.email || '';
                    document.getElementById('client-phone').value = client.phone || '';
                    document.getElementById('client-address').value = client.address || '';
                }
            }
            modal.style.display = 'block';
        }

        let currentClientsData = []; // Store current page data for editing

        async function renderClients() {
            const el = document.getElementById('clients-table');
            el.innerHTML = '<thead><tr><th>ID</th><th>Nombre</th><th>Email</th><th>Tel√©fono</th><th>Direcci√≥n</th><th>Acciones</th></tr></thead><tbody><tr><td colspan="6">Cargando...</td></tr></tbody>';

            const { page, search, perPage } = state.clients;
            const queryParams = new URLSearchParams({ page, per_page: perPage, q: search });

            try {
                const resp = await fetchWithAuth(`/api/clients?${queryParams}`);
                const result = await resp.json();

                if (!resp.ok) { el.innerHTML = `<tr><td colspan="6">${result.error || 'Error de acceso'}</td></tr>`; return; }

                currentClientsData = result.data; // Store for modal usage
                renderPaginationControls('clients', result);

                const tbody = el.querySelector('tbody');
                tbody.innerHTML = '';

                if (result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px;">No se encontraron clientes.</td></tr>';
                    return;
                }

                result.data.forEach(c => {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = c.client_id;
                    row.insertCell().textContent = c.full_name;
                    row.insertCell().textContent = c.email || 'N/A';
                    row.insertCell().textContent = c.phone || 'N/A';
                    row.insertCell().textContent = c.address || 'N/A';

                    const actions = row.insertCell();
                    actions.innerHTML = `
                <button class="btn-action" onclick="openClientModal('edit', ${c.client_id})">Editar</button>
                ${userRole === 'admin' ? `<button class="btn-action btn-delete" onclick="deleteClient(${c.client_id})">Eliminar</button>` : ''}
            `;
                });
                document.getElementById('clients-count').textContent = result.total;
            } catch (e) { el.querySelector('tbody').innerHTML = `<tr><td colspan="6">Error al cargar clientes.</td></tr>`; }
        }

        async function saveClient() {
            const clientId = document.getElementById('client-id').value;
            const isEditing = !!clientId;

            const payload = {
                full_name: document.getElementById('client-name').value,
                email: document.getElementById('client-email').value,
                phone: document.getElementById('client-phone').value,
                address: document.getElementById('client-address').value
            };

            if (!payload.full_name) { alert('El nombre es obligatorio'); return; }

            // Validaciones Frontend
            if (payload.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(payload.email)) {
                alert('Formato de email inv√°lido');
                return;
            }
            if (payload.phone && !/^[0-9]+$/.test(payload.phone)) {
                alert('El tel√©fono debe contener solo n√∫meros');
                return;
            }

            const method = isEditing ? 'PUT' : 'POST';
            const url = isEditing ? `/api/clients/${clientId}` : '/api/clients';

            try {
                const resp = await fetchWithAuth(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const j = await resp.json();
                if (resp.ok) {
                    alert(j.message);
                    closeModal('clientModal');
                    renderClients();
                } else {
                    alert('Error: ' + (j.error || 'Desconocido'));
                }
            } catch (e) { /* Error manejado en fetchWithAuth */ }
        }

        async function deleteClient(clientId) {
            if (userRole !== 'admin') { alert('Solo los administradores pueden eliminar clientes.'); return; }
            if (!confirm('¬øSeguro que desea eliminar a este cliente?')) return;

            try {
                const resp = await fetchWithAuth(`/api/clients/${clientId}`, { method: 'DELETE' });
                const j = await resp.json();
                if (resp.ok) {
                    alert(j.message);
                    renderClients();
                } else {
                    alert('Error al eliminar: ' + (j.error || 'Desconocido'));
                }
            } catch (e) { /* Error manejado en fetchWithAuth */ }
        }


        // ====================================================================
        // GESTI√ìN DE HABITACIONES (CRUD COMPLETO - FALTANTE)
        // ====================================================================

        let currentRoomsData = [];

        function openRoomModal(mode, roomId = null) {
            const modal = document.getElementById('roomModal');
            document.getElementById('room-modal-title').textContent = mode === 'create' ? 'Crear' : 'Editar';

            // Resetear campos
            document.getElementById('room-id').value = '';
            document.getElementById('room-num').value = '';
            document.getElementById('room-type').value = 'sencilla';
            document.getElementById('room-capacity').value = '';
            document.getElementById('room-price').value = '';
            document.getElementById('room-status').value = 'disponible';

            if (mode === 'edit' && roomId) {
                const room = currentRoomsData.find(r => r.room_id === roomId);
                if (room) {
                    document.getElementById('room-id').value = room.room_id;
                    document.getElementById('room-num').value = room.room_num;
                    document.getElementById('room-type').value = room.room_type;
                    document.getElementById('room-capacity').value = room.capacity;
                    document.getElementById('room-price').value = room.price;
                    document.getElementById('room-status').value = room.status;
                }
            }
            modal.style.display = 'block';
        }

        async function saveRoom() {
            const roomId = document.getElementById('room-id').value;
            const isEditing = !!roomId;

            const payload = {
                room_num: parseInt(document.getElementById('room-num').value),
                room_type: document.getElementById('room-type').value,
                capacity: parseInt(document.getElementById('room-capacity').value),
                price: parseFloat(document.getElementById('room-price').value),
                status: document.getElementById('room-status').value,
            };

            if (isNaN(payload.room_num) || isNaN(payload.capacity) || isNaN(payload.price)) {
                alert('Completa todos los campos num√©ricos obligatorios.');
                return;
            }

            const method = isEditing ? 'PUT' : 'POST';
            const url = isEditing ? `/api/rooms/${roomId}` : '/api/rooms';

            try {
                const resp = await fetchWithAuth(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const j = await resp.json();
                if (resp.ok) {
                    alert(j.message);
                    closeModal('roomModal');
                    renderRooms();
                } else {
                    alert('Error: ' + (j.error || 'Desconocido'));
                }
            } catch (e) { /* Error manejado en fetchWithAuth */ }
        }

        async function deleteRoom(roomId) {
            if (userRole !== 'admin') { alert('Solo los administradores pueden eliminar habitaciones.'); return; }
            if (!confirm('¬øSeguro que desea eliminar esta habitaci√≥n?')) return;

            try {
                const resp = await fetchWithAuth(`/api/rooms/${roomId}`, { method: 'DELETE' });
                const j = await resp.json();
                if (resp.ok) {
                    alert(j.message);
                    renderRooms();
                } else {
                    alert('Error al eliminar: ' + (j.error || 'Desconocido'));
                }
            } catch (e) { /* Error manejado en fetchWithAuth */ }
        }


        async function renderRooms() {
            const el = document.getElementById('rooms-table');
            el.innerHTML = '<thead><tr><th>ID</th><th>N√∫mero</th><th>Tipo</th><th>Capacidad</th><th>Tarifa</th><th>Estado</th><th>Acciones</th></tr></thead><tbody><tr><td colspan="7">Cargando...</td></tr></tbody>';

            const { page, search, perPage } = state.rooms;
            const queryParams = new URLSearchParams({ page, per_page: perPage, q: search });

            try {
                const resp = await fetchWithAuth(`/api/rooms?${queryParams}`);
                const result = await resp.json();

                if (!resp.ok) { el.querySelector('tbody').innerHTML = `<tr><td colspan="7">${result.error || 'Error de acceso'}</td></tr>`; return; }

                currentRoomsData = result.data;
                renderPaginationControls('rooms', result);

                const tbody = el.querySelector('tbody');
                tbody.innerHTML = '';

                if (result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px;">No se encontraron habitaciones.</td></tr>';
                    return;
                }

                result.data.forEach(r => {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = r.room_id;
                    row.insertCell().textContent = r.room_num;
                    row.insertCell().textContent = r.room_type;
                    row.insertCell().textContent = r.capacity;
                    row.insertCell().textContent = `$${r.price}`;
                    row.insertCell().textContent = r.status;

                    const actions = row.insertCell();
                    actions.innerHTML = `
                <button class="btn-action" onclick="openRoomModal('edit', ${r.room_id})">Editar</button>
                ${userRole === 'admin' ? `<button class="btn-action btn-delete" onclick="deleteRoom(${r.room_id})">Eliminar</button>` : ''}
            `;
                });
                updateDashboardMetrics(); // Llama a la funci√≥n para actualizar m√©tricas
            } catch (e) { el.querySelector('tbody').innerHTML = `<tr><td colspan="7">Error al cargar habitaciones.</td></tr>`; }
        }


        // ====================================================================
        // GESTI√ìN DE EMPLEADOS (STAFF)
        // ====================================================================

        let currentStaffData = [];

        async function renderStaff() {
            const el = document.getElementById('staff-table');
            el.innerHTML = '<thead><tr><th>ID</th><th>Nombre</th><th>Rol</th><th>√Årea</th><th>Contrataci√≥n</th><th>Activo</th><th>Acciones</th></tr></thead><tbody><tr><td colspan="7">Cargando...</td></tr></tbody>';

            // Solo visible para Admin y Recepci√≥n
            if (userRole !== 'admin' && userRole !== 'recepcion') {
                document.getElementById('staff-section').innerHTML = '<p style="padding:20px;">No tienes permiso para ver esta secci√≥n.</p>';
                return;
            }

            const { page, search, perPage } = state.staff;
            const queryParams = new URLSearchParams({ page, per_page: perPage, q: search });

            try {
                const resp = await fetchWithAuth(`/api/staff?${queryParams}`);
                const result = await resp.json();

                if (!resp.ok) { el.querySelector('tbody').innerHTML = `<tr><td colspan="7">${result.error || 'Error de acceso'}</td></tr>`; return; }

                currentStaffData = result.data;
                renderPaginationControls('staff', result);

                const tbody = el.querySelector('tbody');
                tbody.innerHTML = '';

                if (result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px;">No se encontraron empleados.</td></tr>';
                    return;
                }

                result.data.forEach(s => {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = s.staff_id;
                    row.insertCell().textContent = s.full_name;
                    row.insertCell().textContent = s.staff_role;
                    row.insertCell().textContent = s.area || 'N/A';
                    row.insertCell().textContent = s.hire_date;
                    row.insertCell().textContent = s.active ? 'S√≠' : 'No';

                    const actions = row.insertCell();
                    if (userRole === 'admin') {
                        actions.innerHTML = `
                    <button class="btn-action" onclick="openStaffModal('edit', ${s.staff_id})">Editar</button>
                    <button class="btn-action btn-delete" onclick="deleteStaff(${s.staff_id})">Eliminar</button>
                `;
                    } else {
                        actions.textContent = 'N/A';
                    }
                });
            } catch (e) {
                if (e.message !== 'Forbidden') el.querySelector('tbody').innerHTML = `<tr><td colspan="7">Error al cargar empleados.</td></tr>`;
            }
        }

        function openStaffModal(mode, staffId = null) {
            if (userRole !== 'admin') { alert('Solo los administradores pueden gestionar empleados.'); return; }
            const modal = document.getElementById('staffModal');
            document.getElementById('staff-modal-title').textContent = mode === 'create' ? 'Crear' : 'Editar';

            // Resetear campos
            document.getElementById('staff-id').value = '';
            document.getElementById('staff-name').value = '';
            document.getElementById('staff-role-input').value = 'recepcion';
            document.getElementById('staff-area').value = '';
            document.getElementById('staff-hire-date').value = new Date().toISOString().substring(0, 10);
            document.getElementById('staff-active').value = '1';

            if (mode === 'edit' && staffId) {
                const staff = currentStaffData.find(s => s.staff_id === staffId);
                if (staff) {
                    document.getElementById('staff-id').value = staff.staff_id;
                    document.getElementById('staff-name').value = staff.full_name;
                    document.getElementById('staff-role-input').value = staff.staff_role;
                    document.getElementById('staff-area').value = staff.area || '';
                    document.getElementById('staff-hire-date').value = staff.hire_date;
                    document.getElementById('staff-active').value = staff.active ? '1' : '0';
                }
            }
            modal.style.display = 'block';
        }

        async function saveStaff() {
            if (userRole !== 'admin') return;
            const staffId = document.getElementById('staff-id').value;
            const isEditing = !!staffId;

            const payload = {
                full_name: document.getElementById('staff-name').value,
                staff_role: document.getElementById('staff-role-input').value,
                area: document.getElementById('staff-area').value,
                hire_date: document.getElementById('staff-hire-date').value,
                active: parseInt(document.getElementById('staff-active').value),
            };

            if (!payload.full_name || !payload.staff_role || !payload.hire_date) {
                alert('Completa los campos obligatorios.');
                return;
            }

            const method = isEditing ? 'PUT' : 'POST';
            const url = isEditing ? `/api/staff/${staffId}` : '/api/staff';

            try {
                const resp = await fetchWithAuth(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const j = await resp.json();
                if (resp.ok) {
                    alert(j.message);
                    closeModal('staffModal');
                    renderStaff();
                } else {
                    alert('Error: ' + (j.error || 'Desconocido'));
                }
            } catch (e) { /* Error manejado en fetchWithAuth */ }
        }

        async function deleteStaff(staffId) {
            if (userRole !== 'admin') return;
            if (!confirm('¬øSeguro que desea eliminar a este empleado?')) return;

            try {
                const resp = await fetchWithAuth(`/api/staff/${staffId}`, { method: 'DELETE' });
                const j = await resp.json();
                if (resp.ok) {
                    alert(j.message);
                    renderStaff();
                } else {
                    alert('Error al eliminar: ' + (j.error || 'Desconocido'));
                }
            } catch (e) { /* Error manejado en fetchWithAuth */ }
        }


        // ====================================================================
        // ADMINISTRACI√ìN DE SERVICIOS (SERVICES)
        // ====================================================================

        let currentServicesData = [];

        async function renderServices() {
            const el = document.getElementById('services-table');
            el.innerHTML = '<thead><tr><th>ID</th><th>C√≥digo</th><th>Nombre</th><th>Descripci√≥n</th><th>Precio</th><th>Estado</th><th>Acciones</th></tr></thead><tbody><tr><td colspan="7">Cargando...</td></tr></tbody>';

            // Visible para Admin/Recepci√≥n, pero CRUD solo para Admin
            if (userRole !== 'admin' && userRole !== 'recepcion') {
                document.getElementById('services-section').innerHTML = '<p style="padding:20px;">No tienes permiso para ver esta secci√≥n.</p>';
                return;
            }

            const { page, search, perPage } = state.services;
            const queryParams = new URLSearchParams({ page, per_page: perPage, q: search });

            // Si es recepci√≥n, solo mostrar servicios activos
            if (userRole === 'recepcion') {
                queryParams.append('status', 'activo');
            }

            try {
                const resp = await fetchWithAuth(`/api/services?${queryParams}`);
                const result = await resp.json();

                if (!resp.ok) { el.querySelector('tbody').innerHTML = `<tr><td colspan="7">${result.error || 'Error de acceso'}</td></tr>`; return; }

                currentServicesData = result.data;
                renderPaginationControls('services', result);

                const tbody = el.querySelector('tbody');
                tbody.innerHTML = '';

                if (result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px;">No se encontraron servicios.</td></tr>';
                    return;
                }

                result.data.forEach(s => {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = s.service_id;
                    row.insertCell().textContent = s.service_code;
                    row.insertCell().textContent = s.name;
                    row.insertCell().textContent = s.description ? s.description.substring(0, 30) + (s.description.length > 30 ? '...' : '') : 'N/A';
                    row.insertCell().textContent = `$${s.price}`;
                    row.insertCell().textContent = s.status || 'Activo';

                    const actions = row.insertCell();
                    if (userRole === 'admin') {
                        actions.innerHTML = `
                    <button class="btn-action" onclick="openServiceModal('edit', ${s.service_id})">Editar</button>
                    <button class="btn-action btn-delete" onclick="deleteService(${s.service_id})">Eliminar</button>
                `;
                    } else {
                        actions.textContent = 'N/A';
                    }
                });
            } catch (e) {
                if (e.message !== 'Forbidden') el.querySelector('tbody').innerHTML = `<tr><td colspan="7">Error al cargar servicios.</td></tr>`;
            }
        }

        function openServiceModal(mode, serviceId = null) {
            if (userRole !== 'admin') { alert('Solo los administradores pueden gestionar servicios.'); return; }
            const modal = document.getElementById('serviceModal');
            document.getElementById('service-modal-title').textContent = mode === 'create' ? 'Crear' : 'Editar';

            // Resetear campos
            document.getElementById('service-id').value = '';
            document.getElementById('service-code').value = '';
            document.getElementById('service-name').value = '';
            document.getElementById('service-price').value = '';
            document.getElementById('service-description').value = '';

            if (mode === 'edit' && serviceId) {
                const service = currentServicesData.find(s => s.service_id === serviceId);
                if (service) {
                    document.getElementById('service-id').value = service.service_id;
                    document.getElementById('service-code').value = service.service_code;
                    document.getElementById('service-name').value = service.name;
                    document.getElementById('service-price').value = service.price;
                    document.getElementById('service-description').value = service.description || '';
                }
            }
            modal.style.display = 'block';
        }

        async function saveService() {
            if (userRole !== 'admin') return;
            const serviceId = document.getElementById('service-id').value;
            const isEditing = !!serviceId;

            const payload = {
                service_code: document.getElementById('service-code').value,
                name: document.getElementById('service-name').value,
                price: parseFloat(document.getElementById('service-price').value),
                description: document.getElementById('service-description').value,
            };

            if (!payload.service_code || !payload.name || isNaN(payload.price)) {
                alert('Completa los campos obligatorios (C√≥digo, Nombre, Precio).');
                return;
            }

            const method = isEditing ? 'PUT' : 'POST';
            const url = isEditing ? `/api/services/${serviceId}` : '/api/services';

            try {
                const resp = await fetchWithAuth(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const j = await resp.json();
                if (resp.ok) {
                    alert(j.message);
                    closeModal('serviceModal');
                    renderServices();
                } else {
                    alert('Error: ' + (j.error || 'Desconocido'));
                }
            } catch (e) { /* Error manejado en fetchWithAuth */ }
        }

        async function deleteService(serviceId) {
            if (userRole !== 'admin') return;
            if (!confirm('¬øSeguro que desea eliminar este servicio?')) return;

            try {
                const resp = await fetchWithAuth(`/api/services/${serviceId}`, { method: 'DELETE' });
                if (resp.ok) {
                    const j = await resp.json();
                    alert(j.message);
                    renderServices();
                } else {
                    const j = await resp.json();
                    alert('Error al eliminar: ' + (j.error || 'Desconocido'));
                }
            } catch (e) { /* Error manejado en fetchWithAuth */ }
        }


        // ====================================================================
        // GESTI√ìN DE RESERVAS (CRUD COMPLETO)
        // ====================================================================

        let currentReservationsData = [];

        // --- NUEVA FUNCI√ìN DE ABRIR MODAL DE RESERVA (Creaci√≥n/Edici√≥n Principal) ---
        // (La funci√≥n openReservationModal se define m√°s abajo con populateSelect, eliminamos la versi√≥n antigua aqu√≠)

        // --- NUEVA FUNCI√ìN DE GUARDAR RESERVA (Creaci√≥n/Edici√≥n Principal) ---
        async function saveReservation() {
            const resId = document.getElementById('reservation-id').value;
            const isEditing = !!resId;

            const payload = {
                client_id: parseInt(document.getElementById('res-client-select').value),
                room_id: parseInt(document.getElementById('res-room-select').value),
                checkin_date: document.getElementById('res-checkin').value,
                checkout_date: document.getElementById('res-checkout').value,
                total: parseFloat(document.getElementById('res-total').value),
                status: document.getElementById('res-status-new').value,
                // Asumiendo que el campo guest_name se saca del client_id en el backend o es el nombre completo del cliente
                // guest_name se maneja en backend si no se env√≠a
            };

            if (isNaN(payload.client_id) || isNaN(payload.room_id) || !payload.checkin_date || !payload.checkout_date) {
                alert('Selecciona cliente, habitaci√≥n y fechas.');
                return;
            }

            const method = isEditing ? 'PUT' : 'POST';
            // Si editamos, usamos el endpoint de solo status, pero si pasamos todos los datos (como aqu√≠),
            // asumimos que el backend maneja una ruta completa. Usamos la ruta completa para consistencia.
            const url = isEditing ? `/api/reservations/${resId}` : '/api/reservations';

            try {
                const resp = await fetchWithAuth(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const j = await resp.json();
                if (resp.ok) {
                    alert(j.message || 'Reserva guardada exitosamente.');
                    closeModal('reservationModal');
                    // Recargar todo, ya que una reserva impacta rooms y reservations
                    await Promise.all([renderRooms(), renderReservations()]);
                } else {
                    alert('Error: ' + (j.error || 'Desconocido'));
                }
            } catch (e) { /* Error manejado en fetchWithAuth */ }
        }

        // --- NUEVA FUNCI√ìN DE ELIMINAR RESERVA ---
        async function deleteReservation(resId) {
            if (userRole !== 'admin') { alert('Solo los administradores pueden eliminar reservas.'); return; }
            if (!confirm('¬øSeguro que desea eliminar esta reserva? Esta acci√≥n es irreversible.')) return;

            try {
                const resp = await fetchWithAuth(`/api/reservations/${resId}`, { method: 'DELETE' });
                const j = await resp.json();
                if (resp.ok) {
                    alert(j.message);
                    // Recargar todo, ya que una eliminaci√≥n impacta rooms y reservations
                    await Promise.all([renderRooms(), renderReservations()]);
                } else {
                    alert('Error al eliminar: ' + (j.error || 'Desconocido'));
                }
            } catch (e) { /* Error manejado en fetchWithAuth */ }
        }

        // --- FUNCI√ìN DE RENDERIZAR RESERVAS (modificada para incluir bot√≥n de eliminar) ---
        async function renderReservations() {
            const el = document.getElementById('reservations-table');
            el.innerHTML = '<thead><tr><th>C√≥digo</th><th>Hab.</th><th>Hu√©sped</th><th>Check-in</th><th>Check-out</th><th>Total Est.</th><th>Estado</th><th>Acciones</th></tr></thead><tbody><tr><td colspan="8">Cargando...</td></tr></tbody>';

            const { page, search, perPage } = state.reservations;
            const queryParams = new URLSearchParams({ page, per_page: perPage, q: search });

            try {
                const resp = await fetchWithAuth(`/api/reservations?${queryParams}`);
                const result = await resp.json();

                if (!resp.ok) { el.querySelector('tbody').innerHTML = `<tr><td colspan="8">${result.error || 'Error de acceso'}</td></tr>`; return; }

                currentReservationsData = result.data;
                renderPaginationControls('reservations', result);

                const tbody = el.querySelector('tbody');
                tbody.innerHTML = '';

                if (result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px;">No se encontraron reservas.</td></tr>';
                    return;
                }

                result.data.forEach(r => {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = r.reservation_code || `R${r.reservation_id}`;
                    row.insertCell().textContent = r.room_num || 'N/A'; // room_num viene del JOIN
                    row.insertCell().textContent = r.guest_name;
                    row.insertCell().textContent = r.checkin_date;
                    row.insertCell().textContent = r.checkout_date;
                    row.insertCell().textContent = `$${r.total}`; // Total Inicial / Estimado
                    row.insertCell().textContent = r.status;

                    const actions = row.insertCell();

                    const isBilled = r.status === 'facturada';
                    const isDisabledVisual = r.status !== 'checkout' && !isBilled ? 'btn-disabled-visual' : '';

                    const billingAction = isBilled
                        ? '<span style="color: var(--muted); font-weight: bold;">Facturada</span>'
                        : `<button class="btn-action ${isDisabledVisual}" onclick="handleFacturarClick(${r.reservation_id}, ${r.total}, '${r.status}')">Facturar</button>`;

                    actions.innerHTML = `
                <button class="btn-action" onclick="openReservationEditModal(${r.reservation_id})">Estado</button>
                ${billingAction}
                ${userRole === 'admin' ? `<button class="btn-action btn-delete" onclick="deleteReservation(${r.reservation_id})">Eliminar</button>` : ''}
            `;
                });
                updateDashboardMetrics();
            } catch (e) {
                el.querySelector('tbody').innerHTML = `<tr><td colspan="8">Error al cargar reservas.</td></tr>`;
            }
        }

        // --- FUNCIONES DE GESTI√ìN DE RESERVA EXISTENTE (openReservationEditModal, saveReservationStatus, addServiceToReservation) SIN CAMBIOS ---

        // --- FUNCIONES DE GESTI√ìN DE RESERVA EXISTENTE ---

        // --- FUNCIONES DE GESTI√ìN DE RESERVA EXISTENTE ---

        function openReservationEditModal(resId) {
            const res = currentReservationsData.find(r => r.reservation_id === resId);
            if (!res) return;

            document.getElementById('res-edit-id').value = resId;
            document.getElementById('res-edit-code').textContent = res.reservation_code || `R${resId}`;
            document.getElementById('res-status-input').value = res.status;
            document.getElementById('res-status-message').textContent = `Estado actual: ${res.status}.`;

            // Ocultar secci√≥n de servicios
            document.getElementById('add-service-section').style.display = 'none';
            document.getElementById('reservationEditModal').style.display = 'block';
        }

        function openReservationServicesModal(resId) {
            const res = currentReservationsData.find(r => r.reservation_id === resId);
            if (!res) return;

            document.getElementById('res-edit-id').value = resId;
            document.getElementById('res-edit-code').textContent = res.reservation_code || `R${resId}`;

            // Ocultar secci√≥n de estado, mostrar servicios
            // Nota: Reutilizamos el mismo modal pero ocultamos partes. 
            // Idealmente ser√≠an modales distintos, pero por rapidez manipulamos el DOM.
            // Para hacerlo bien, deber√≠amos tener IDs √∫nicos para los contenedores de "Estado" y "Servicios" dentro del modal.
            // Como no los tengo en el HTML original (solo add-service-section), voy a ocultar el select de status.

            // Hack: Ocultar controles de estado
            document.getElementById('res-status-input').parentElement.style.display = 'none'; // Oculta label+select si est√°n en bloque? No, solo el select.
            // Mejor: Asumimos que el usuario quiere ver solo servicios.

            // Vamos a mostrar todo pero enfocado en servicios? No, el usuario pidi√≥ dividir.
            // Voy a modificar el HTML del modal para tener secciones con IDs.
            // Como no puedo modificar el HTML del modal f√°cilmente en este chunk sin ver todo el archivo,
            // Voy a usar JS para ocultar los elementos espec√≠ficos.

            document.getElementById('res-status-input').style.display = 'none';
            document.querySelector('label[for="res-status-input"]').style.display = 'none';
            document.getElementById('res-status-message').style.display = 'none';
            document.querySelector('button[onclick="saveReservationStatus()"]').style.display = 'none';

            document.getElementById('add-service-section').style.display = 'block';

            // Llenar servicios
            populateSelect('/api/services', 'res-service-select', s => `${s.name} ($${s.price})`, 'service_id');

            document.getElementById('reservationEditModal').style.display = 'block';

            // Restaurar visibilidad al cerrar? Necesitamos un handler de cierre que restaure.
            // O mejor, en openReservationEditModal restauramos la visibilidad.
        }

        // Modificamos openReservationEditModal para restaurar visibilidad
        const originalOpenEdit = openReservationEditModal;
        openReservationEditModal = function (resId) {
            // Restaurar elementos de estado
            document.getElementById('res-status-input').style.display = 'inline-block';
            document.querySelector('label[for="res-status-input"]').style.display = 'inline-block';
            document.getElementById('res-status-message').style.display = 'block';
            document.querySelector('button[onclick="saveReservationStatus()"]').style.display = 'inline-block';

            // Ocultar servicios
            document.getElementById('add-service-section').style.display = 'none';

            // Llamar l√≥gica original (copiada arriba)
            const res = currentReservationsData.find(r => r.reservation_id === resId);
            if (!res) return;

            document.getElementById('res-edit-id').value = resId;
            document.getElementById('res-edit-code').textContent = res.reservation_code || `R${resId}`;
            document.getElementById('res-status-input').value = res.status;
            document.getElementById('res-status-message').textContent = `Estado actual: ${res.status}.`;

            document.getElementById('reservationEditModal').style.display = 'block';
        }

        async function saveReservationStatus() {
            const resId = document.getElementById('res-edit-id').value;
            const newStatus = document.getElementById('res-status-input').value;

            const payload = { status: newStatus };

            try {
                const resp = await fetchWithAuth(`/api/reservations/${resId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const j = await resp.json();
                if (resp.ok) {
                    alert(`Estado de reserva ${resId} actualizado a ${newStatus}`);
                    closeModal('reservationEditModal');
                    // Recargar todo
                    await Promise.all([renderRooms(), renderReservations()]);
                } else {
                    alert('Error al actualizar estado: ' + (j.error || 'Desconocido'));
                }
            } catch (e) { /* Error manejado en fetchWithAuth */ }
        }

        async function addServiceToReservation() {
            const resId = document.getElementById('res-edit-id').value;
            const serviceId = document.getElementById('res-service-select').value;
            const quantity = parseInt(document.getElementById('res-service-quantity').value);

            if (quantity <= 0 || !serviceId) {
                alert('Selecciona un servicio y una cantidad v√°lida.');
                return;
            }

            const payload = { service_id: parseInt(serviceId), quantity: quantity };

            try {
                const resp = await fetchWithAuth(`/api/reservations/${resId}/services`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const j = await resp.json();
                if (resp.ok) {
                    alert(`Servicio a√±adido a la reserva ${resId}.`);
                    document.getElementById('res-service-quantity').value = 1;
                } else {
                    alert('Error al a√±adir servicio: ' + (j.error || 'Desconocido'));
                }
            } catch (e) { /* Error manejado en fetchWithAuth */ }
        }


        // ====================================================================
        // FACTURACI√ìN (INVOICES) - CRUD Completo
        // ====================================================================

        // --- FUNCI√ìN DE ABRIR MODAL DE FACTURA (Creaci√≥n/Edici√≥n) ---
        async function openInvoiceModal(mode, invoiceId = null) {
            if (userRole !== 'admin') { alert('Solo los administradores pueden gestionar facturas.'); return; }

            const modal = document.getElementById('invoiceModal');
            document.getElementById('invoice-modal-title').textContent = mode === 'create' ? 'Crear' : 'Editar';

            // Resetear campos
            document.getElementById('invoice-id').value = '';
            document.getElementById('invoice-total').value = '0.00';
            document.getElementById('invoice-method').value = 'efectivo';
            document.getElementById('invoice-date').value = new Date().toISOString().substring(0, 10);

            // Llenar select de Reservas Facturables (Checkout)
            // Usamos el nuevo filtro de status en la API
            // Traemos las de 'checkout' y 'facturada' (para poder editar facturas existentes)
            // Como el filtro es √∫nico, hacemos dos llamadas o asumimos que al crear solo queremos 'checkout'.
            // Al editar, si ya est√° facturada, necesitamos traer esa espec√≠fica.

            const select = document.getElementById('invoice-res-select');
            select.innerHTML = '<option value="">Cargando...</option>';

            try {
                // Traer reservas en checkout para nueva factura
                const respCheckout = await fetchWithAuth('/api/reservations?status=checkout&per_page=100');
                const dataCheckout = (await respCheckout.json()).data || [];

                // Si estamos editando, necesitamos la reserva asociada aunque est√© 'facturada'
                let dataFacturada = [];
                if (mode === 'edit' && invoiceId) {
                    // Podr√≠amos buscar la factura primero para saber la reservation_id
                    // Pero aqu√≠ asumimos que la tenemos en currentInvoicesData o la buscamos
                    // Simplificaci√≥n: Traemos tambi√©n las facturadas recientes
                    const respFacturada = await fetchWithAuth('/api/reservations?status=facturada&per_page=50');
                    dataFacturada = (await respFacturada.json()).data || [];
                }

                const allRes = [...dataCheckout, ...dataFacturada];
                // Eliminar duplicados si los hubiera
                const uniqueRes = Array.from(new Map(allRes.map(item => [item.reservation_id, item])).values());

                select.innerHTML = '';
                if (uniqueRes.length > 0) {
                    uniqueRes.forEach(r => {
                        const opt = document.createElement('option');
                        opt.value = r.reservation_id;
                        opt.textContent = `R${r.reservation_id} - ${r.guest_name} ($${r.total}) [${r.status.toUpperCase()}]`;
                        select.appendChild(opt);
                    });
                } else {
                    select.innerHTML = '<option value="">No hay reservas pendientes de facturar</option>';
                }

            } catch (e) {
                select.innerHTML = '<option value="">Error al cargar</option>';
            }

            if (mode === 'edit' && invoiceId) {
                // Buscar en currentInvoicesData
                // Necesitamos definir currentInvoicesData en renderInvoices
                // Asumimos que existe (lo definiremos en renderInvoices si no est√°)
                const invoice = (typeof currentInvoicesData !== 'undefined' ? currentInvoicesData : []).find(i => i.invoice_id == invoiceId);

                if (invoice) {
                    document.getElementById('invoice-id').value = invoice.invoice_id;
                    document.getElementById('invoice-res-select').value = invoice.reservation_id;
                    document.getElementById('invoice-total').value = invoice.total;
                    document.getElementById('invoice-method').value = invoice.method;
                    document.getElementById('invoice-date').value = invoice.invoice_date;
                }
            }
            modal.style.display = 'block';
        }

        // --- FUNCI√ìN DE GUARDAR FACTURA (Creaci√≥n/Edici√≥n) ---
        async function saveInvoice() {
            if (userRole !== 'admin') return;
            const invoiceId = document.getElementById('invoice-id').value;
            const isEditing = !!invoiceId;

            const payload = {
                reservation_id: parseInt(document.getElementById('invoice-res-select').value),
                total: parseFloat(document.getElementById('invoice-total').value),
                method: document.getElementById('invoice-method').value,
                invoice_date: document.getElementById('invoice-date').value,
            };

            if (isNaN(payload.reservation_id) || isNaN(payload.total)) {
                alert('Selecciona una reserva y completa el total.');
                return;
            }

            const method = isEditing ? 'PUT' : 'POST';
            const url = isEditing ? `/api/invoices/${invoiceId}` : '/api/invoices';

            try {
                const resp = await fetchWithAuth(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const j = await resp.json();
                if (resp.ok) {
                    alert(j.message || 'Factura guardada exitosamente.');
                    closeModal('invoiceModal');
                    // Si se crea/edita una factura, debemos actualizar su reserva a 'facturada' si no lo est√°.
                    if (!isEditing) {
                        await fetchWithAuth(`/api/reservations/${payload.reservation_id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ status: 'facturada' })
                        });
                    }
                    await Promise.all([renderReservations(), renderInvoices()]);
                } else {
                    alert('Error: ' + (j.error || 'Desconocido'));
                }
            } catch (e) { /* Error manejado en fetchWithAuth */ }
        }

        // --- FUNCI√ìN DE ELIMINAR FACTURA ---
        async function deleteInvoice(invoiceId) {
            if (userRole !== 'admin') return;
            if (!confirm('¬øSeguro que desea eliminar esta factura? Si la elimina, la reserva asociada se mantendr√° en Check-out.')) return;

            try {
                // En un sistema real, primero buscar√≠amos la reserva, la pondr√≠amos en 'checkout'
                // y luego eliminar√≠amos la factura. Aqu√≠ solo eliminamos.
                const resp = await fetchWithAuth(`/api/invoices/${invoiceId}`, { method: 'DELETE' });
                const j = await resp.json();
                if (resp.ok) {
                    alert(j.message);
                    // Si la reserva asociada estaba 'facturada', deber√≠amos cambiarla a 'checkout'
                    // Esto requerir√≠a l√≥gica extra. Por simplicidad, solo recargamos.
                    await renderInvoices();
                } else {
                    alert('Error al eliminar: ' + (j.error || 'Desconocido'));
                }
            } catch (e) { /* Error manejado en fetchWithAuth */ }
        }


        // --- FUNCI√ìN DE RENDERIZAR FACTURAS (modificada para incluir CRUD) ---

        let currentInvoicesData = [];

        async function renderInvoices() {
            const el = document.getElementById('invoices-table');
            el.innerHTML = '<thead><tr><th>ID Factura</th><th>Reserva ID</th><th>Total</th><th>M√©todo</th><th>Fecha</th><th>Acciones</th></tr></thead><tbody><tr><td colspan="6">Cargando...</td></tr></tbody>';

            // Ocultar el bot√≥n de "Nueva Factura" si no es Admin
            if (userRole !== 'admin') {
                document.getElementById('btn-add-invoice').style.display = 'none';
            } else {
                document.getElementById('btn-add-invoice').style.display = 'block';
            }

            const { page, search, perPage } = state.invoices;
            const queryParams = new URLSearchParams({ page, per_page: perPage, q: search });

            try {
                const resp = await fetchWithAuth(`/api/invoices?${queryParams}`);
                const result = await resp.json();

                if (!resp.ok) { el.querySelector('tbody').innerHTML = `<tr><td colspan="6">${result.error || 'Error de acceso'}</td></tr>`; return; }

                currentInvoicesData = result.data;
                renderPaginationControls('invoices', result);

                const tbody = el.querySelector('tbody');
                tbody.innerHTML = '';

                if (result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px;">No se encontraron facturas.</td></tr>';
                    return;
                }

                result.data.forEach(i => {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = i.invoice_id;
                    row.insertCell().textContent = i.reservation_id;
                    row.insertCell().textContent = `$${i.total}`;
                    row.insertCell().textContent = i.method;
                    row.insertCell().textContent = i.invoice_date;

                    const actions = row.insertCell();
                    if (userRole === 'admin') {
                        actions.innerHTML = `
                    <button class="btn-action" onclick="openInvoiceModal('edit', ${i.invoice_id})">Editar</button>
                    <button class="btn-action btn-delete" onclick="deleteInvoice(${i.invoice_id})">Eliminar</button>
                `;
                    } else {
                        actions.textContent = 'N/A';
                    }
                });
                // updateDashboardMetrics(); // Ya no es necesario llamarlo aqu√≠, se llama al cambiar tab o init
            } catch (e) {
                el.querySelector('tbody').innerHTML = `<tr><td colspan="6">Error al cargar facturas.</td></tr>`;
            }
        }


        // --- FUNCI√ìN DE FACTURACI√ìN R√ÅPIDA (handleFacturarClick) SIN CAMBIOS ---

        function handleFacturarClick(resId, totalAmount, status) {
            if (status === 'facturada') {
                alert(`ERROR: La Reserva ${resId} ya ha sido Facturada.`);
                return;
            }

            if (status !== 'checkout') {
                alert(`Solo se puede Facturar una reserva en estado "Check-out". Estado actual: ${status.toUpperCase()}.`);
                return;
            }

            // Si el estado es 'checkout', proceder con la facturaci√≥n
            createInvoiceFromReservation(resId, totalAmount);
        }

        // Renombrada para evitar conflicto con saveInvoice
        async function createInvoiceFromReservation(resId, totalAmount) {
            // Usamos currentReservationsData ya que el click viene de la tabla renderizada
            const reservation = currentReservationsData.find(r => r.reservation_id === resId);

            if (reservation && reservation.status === 'facturada') {
                alert(`ERROR: La Reserva ${resId} ya tiene una factura generada.`);
                return;
            }

            if (!confirm(`¬øGenerar factura final para la Reserva ${resId} por $${totalAmount} (estimado) con pago en Efectivo?`)) return;

            // Aqu√≠ deber√≠as tener una forma de calcular el total final incluyendo servicios
            // Por simplicidad, usamos el total estimado
            const finalTotal = totalAmount;

            const payload = {
                reservation_id: resId,
                total: finalTotal,
                method: 'efectivo', // Valor predeterminado
                invoice_date: new Date().toISOString().substring(0, 10)
            };

            try {
                const resp = await fetchWithAuth('/api/invoices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const j = await resp.json();
                if (resp.ok) {
                    alert(`Factura ${j.invoice_id} generada exitosamente.`);
                    // Marcar la reserva como Facturada
                    await fetchWithAuth(`/api/reservations/${resId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'facturada' })
                    });
                    await Promise.all([renderReservations(), renderInvoices()]); // Recargar ambos
                } else {
                    alert('Error al facturar: ' + (j.error || 'Desconocido'));
                }
            } catch (e) { /* Error manejado en fetchWithAuth */ }
        }


        // ====================================================================
        // ACTUALIZACI√ìN DE M√âTRICAS E INICIO
        // ====================================================================

        // ====================================================================
        // ACTUALIZACI√ìN DE M√âTRICAS E INICIO
        // ====================================================================
        // AUTOCOMPLETE HELPER (NUEVO)
        // ====================================================================
        function setupAutocomplete(inputId, hiddenId, resultsId, apiEndpoint, displayFn, onSelectCallback = null) {
            const input = document.getElementById(inputId);
            const hidden = document.getElementById(hiddenId);
            const results = document.getElementById(resultsId);

            let timeout = null;

            input.addEventListener('input', function () {
                const query = this.value;
                clearTimeout(timeout);

                if (query.length < 2) {
                    results.style.display = 'none';
                    return;
                }

                timeout = setTimeout(async () => {
                    try {
                        // Usamos el endpoint de b√∫squeda existente
                        const separator = apiEndpoint.includes('?') ? '&' : '?';
                        const resp = await fetchWithAuth(`${apiEndpoint}${separator}q=${encodeURIComponent(query)}&per_page=10`);
                        const data = (await resp.json()).data;

                        results.innerHTML = '';
                        if (data.length > 0) {
                            data.forEach(item => {
                                const div = document.createElement('div');
                                div.textContent = displayFn(item);
                                div.onclick = () => {
                                    input.value = displayFn(item);
                                    hidden.value = item.client_id || item.room_id || item.service_id || item.id; // Fallback ID detection
                                    results.style.display = 'none';
                                    if (onSelectCallback) onSelectCallback(item);
                                };
                                results.appendChild(div);
                            });
                            results.style.display = 'block';
                        } else {
                            results.style.display = 'none';
                        }
                    } catch (e) {
                        console.error("Autocomplete error", e);
                    }
                }, 300);
            });

            // Cerrar al hacer click fuera
            document.addEventListener('click', function (e) {
                if (e.target !== input && e.target !== results) {
                    results.style.display = 'none';
                }
            });
        }

        // ====================================================================
        // RENDER FUNCTIONS (Actualizadas)
        // ====================================================================

        async function renderReservationServices() {
            const el = document.getElementById('reservation_services-table');
            el.innerHTML = '<thead><tr><th>Fecha</th><th>Cliente</th><th>Habitaci√≥n</th><th>Servicio</th><th>Cant.</th><th>Total</th><th>Acciones</th></tr></thead><tbody><tr><td colspan="7">Cargando...</td></tr></tbody>';

            const { page, search, perPage } = state.reservation_services || { page: 1, search: '', perPage: 10 };
            if (!state.reservation_services) state.reservation_services = { page: 1, search: '', perPage: 10 };

            const queryParams = new URLSearchParams({ page, per_page: perPage, q: search });

            try {
                const resp = await fetchWithAuth(`/api/reservation_services?${queryParams}`);
                const result = await resp.json();

                if (!resp.ok) { el.querySelector('tbody').innerHTML = `<tr><td colspan="7">${result.error || 'Error'}</td></tr>`; return; }

                renderPaginationControls('reservation_services', result);

                const tbody = el.querySelector('tbody');
                tbody.innerHTML = '';

                if (result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px;">No se encontraron registros.</td></tr>';
                    return;
                }

                result.data.forEach(r => {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = r.service_date;
                    row.insertCell().textContent = r.client_name;
                    row.insertCell().textContent = `${r.room_num} (${r.reservation_code})`;
                    row.insertCell().textContent = r.service_name;
                    row.insertCell().textContent = r.quantity;
                    row.insertCell().textContent = `$${r.line_total}`;

                    const actionsCell = row.insertCell();
                    actionsCell.innerHTML = `
                        <button class="btn-action" onclick='openServiceReservationEditModal(${JSON.stringify(r)})'>Editar</button>
                        <button class="btn-action btn-delete" onclick="deleteServiceReservation(${r.reservation_service_id})">Eliminar</button>
                    `;
                });
            } catch (e) {
                el.querySelector('tbody').innerHTML = `<tr><td colspan="7">Error al cargar datos.</td></tr>`;
            }
        }

        async function updateDashboardMetrics() {
            try {
                const resp = await fetchWithAuth('/api/dashboard');
                const data = await resp.json();

                if (resp.ok) {
                    document.getElementById('active-count').textContent = data.active_reservations;
                    document.getElementById('ocupacion').textContent = data.occupancy_rate + '%';
                    document.getElementById('ingresos').textContent = '$' + data.total_income;
                    document.getElementById('clients-count').textContent = data.total_clients;

                    // Nuevas m√©tricas
                    if (document.getElementById('total-rooms')) document.getElementById('total-rooms').textContent = data.total_rooms;
                    if (document.getElementById('maintenance-rooms')) document.getElementById('maintenance-rooms').textContent = data.maintenance_rooms;
                    if (document.getElementById('available-rooms')) document.getElementById('available-rooms').textContent = data.available_rooms;
                    if (document.getElementById('occupied-rooms')) document.getElementById('occupied-rooms').textContent = data.occupied_rooms;
                }
            } catch (e) {
                console.error("Error cargando dashboard", e);
            }
        }

        async function populateSelect(url, selectId, textFn, valueKey) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Cargando...</option>';
            try {
                const resp = await fetchWithAuth(url + '?per_page=100');
                const data = (await resp.json()).data;
                select.innerHTML = '<option value="">Seleccionar...</option>';
                data.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item[valueKey];
                    opt.textContent = textFn(item);
                    select.appendChild(opt);
                });
                return data;
            } catch (e) {
                select.innerHTML = '<option value="">Error al cargar</option>';
                return [];
            }
        }

        let selectedReservationRoom = null; // Para guardar datos de la habitaci√≥n seleccionada

        // --- NUEVA FUNCI√ìN DE ABRIR MODAL DE RESERVA (Creaci√≥n/Edici√≥n Principal) ---
        function openReservationModal(mode, resId = null) {
            const modal = document.getElementById('reservationModal');
            document.getElementById('reservation-modal-title').textContent = mode === 'create' ? 'Crear' : 'Editar';

            // Resetear campos
            document.getElementById('reservation-id').value = '';

            // Reset Autocomplete
            document.getElementById('res-client-search').value = '';
            document.getElementById('res-client-select').value = '';
            document.getElementById('res-room-search').value = '';
            document.getElementById('res-room-select').value = '';
            selectedReservationRoom = null;

            document.getElementById('res-checkin').value = new Date().toISOString().substring(0, 10);
            document.getElementById('res-checkout').value = new Date().toISOString().substring(0, 10);
            document.getElementById('res-total').value = '0.00';
            document.getElementById('res-status-new').value = 'reservada';

            // Si estamos editando, cargar datos (Fetch individual para asegurar tener nombres)
            if (mode === 'edit' && resId) {
                const res = currentReservationsData.find(r => r.reservation_id == resId);
                if (res) {
                    document.getElementById('reservation-id').value = res.reservation_id;

                    // Setear valores ocultos y visibles (Idealmente fetch para obtener nombres si no est√°n en 'res')
                    // 'res' tiene client_name y room_num gracias al JOIN del backend
                    document.getElementById('res-client-select').value = res.client_id;
                    document.getElementById('res-client-search').value = res.client_name || `Cliente ${res.client_id}`;

                    document.getElementById('res-room-select').value = res.room_id;
                    document.getElementById('res-room-search').value = res.room_num || `Habitaci√≥n ${res.room_id}`;

                    // Guardar datos de habitaci√≥n para rec√°lculo
                    if (res.room_price) {
                        selectedReservationRoom = { price: res.room_price, room_id: res.room_id };
                    }

                    document.getElementById('res-checkin').value = res.checkin_date;
                    document.getElementById('res-checkout').value = res.checkout_date;
                    document.getElementById('res-total').value = res.total;
                    document.getElementById('res-status-new').value = res.status;
                }
            }

            // Listeners para c√°lculo autom√°tico
            document.getElementById('res-checkin').onchange = calculateTotal;
            document.getElementById('res-checkout').onchange = calculateTotal;

            modal.style.display = 'block';
        }

        function calculateTotal() {
            const roomId = document.getElementById('res-room-select').value;
            const checkinVal = document.getElementById('res-checkin').value;
            const checkoutVal = document.getElementById('res-checkout').value;

            if (!roomId || !checkinVal || !checkoutVal || !selectedReservationRoom) return;

            const start = new Date(checkinVal);
            const end = new Date(checkoutVal);
            const diffTime = end - start;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const days = diffDays > 0 ? diffDays : 1;

            const total = selectedReservationRoom.price * days;
            document.getElementById('res-total').value = total.toFixed(2);
        }

        /* INIT */
        async function init() {
            if (!userRole || !allowedRoles.includes(userRole)) {
                alert('Acceso no autorizado. Inicie sesi√≥n con un rol v√°lido.');
                window.location.href = './login.html';
                return;
            }

            document.title = `Hotel R&G - Panel ${userRole.toUpperCase()}`;
            document.getElementById('user-role-display').textContent = userRole.toUpperCase();

            if (userRole === 'recepcion') {
                document.getElementById('staff-section').style.display = 'none';
                document.getElementById('nav-staff').style.display = 'none'; // Hide sidebar item
                // Services section is visible for reception, but read-only
                document.getElementById('btn-add-service').style.display = 'none';
                document.getElementById('btn-add-invoice').style.display = 'none';
            } else {
                document.getElementById('staff-section').style.display = '';
                document.getElementById('nav-staff').style.display = '';
                document.getElementById('btn-add-service').style.display = 'block';
                document.getElementById('btn-add-invoice').style.display = 'block';
            }

            // Ocultar secci√≥n de servicios si no es admin/recepcion/spa?
            // Asumimos que todos los roles definidos pueden verla, o ajustamos seg√∫n necesidad.

            // Carga inicial
            switchTab('dashboard');

            // Inicializar Autocompletes
            setupAutocomplete('srv-res-client-search', 'srv-res-client', 'srv-res-client-results', '/api/clients', c => `${c.full_name} (${c.email})`, (item) => loadClientActiveReservations(item.client_id));
            setupAutocomplete('srv-res-service-search', 'srv-res-service', 'srv-res-service-results', '/api/services', s => `${s.name} ($${s.price})`);

            // Autocomplete para Nueva Reserva (FILTRAR HABITACIONES DISPONIBLES)
            setupAutocomplete('res-client-search', 'res-client-select', 'res-client-results', '/api/clients', c => `${c.full_name}`, null);
            setupAutocomplete('res-room-search', 'res-room-select', 'res-room-results', '/api/rooms?status=disponible', r => `${r.room_num} - ${r.room_type} ($${r.price})`, (item) => {
                selectedReservationRoom = item;
                calculateTotal();
            });
        }

        // --- FUNCIONES CRUD RESERVA SERVICIOS ---
        function openServiceReservationEditModal(r) {
            document.getElementById('edit-srv-res-id').value = r.reservation_service_id;
            document.getElementById('edit-srv-name').textContent = r.service_name;
            document.getElementById('edit-srv-res-code').textContent = r.reservation_code;
            document.getElementById('edit-srv-date').value = r.service_date;
            document.getElementById('edit-srv-qty').value = r.quantity;

            document.getElementById('serviceReservationEditModal').style.display = 'block';
        }

        async function updateServiceReservation() {
            const id = document.getElementById('edit-srv-res-id').value;
            const date = document.getElementById('edit-srv-date').value;
            const qty = document.getElementById('edit-srv-qty').value;

            if (!date || !qty) return alert("Campos requeridos");

            try {
                const resp = await fetchWithAuth(`/api/reservation_services/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ service_date: date, quantity: qty })
                });
                if (resp.ok) {
                    alert("Actualizado correctamente");
                    closeModal('serviceReservationEditModal');
                    renderReservationServices();
                } else {
                    alert("Error al actualizar");
                }
            } catch (e) {
                alert("Error de conexi√≥n");
            }
        }

        async function deleteServiceReservation(id) {
            if (!confirm("¬øSeguro que desea eliminar este servicio? Se recalcular√° el total de la reserva.")) return;
            try {
                const resp = await fetchWithAuth(`/api/reservation_services/${id}`, { method: 'DELETE' });
                if (resp.ok) {
                    alert("Eliminado correctamente");
                    renderReservationServices();
                } else {
                    alert("Error al eliminar");
                }
            } catch (e) {
                alert("Error de conexi√≥n");
            }
        }

        // --- L√ìGICA PARA RESERVA DE SERVICIOS (NUEVO) ---

        function openServiceReservationModal() {
            const modal = document.getElementById('serviceReservationModal');

            // Resetear
            document.getElementById('srv-res-client-search').value = '';
            document.getElementById('srv-res-client').value = '';

            document.getElementById('srv-res-id').innerHTML = '<option value="">Seleccione un cliente primero</option>';
            document.getElementById('srv-res-id').disabled = true;

            document.getElementById('srv-res-service-search').value = '';
            document.getElementById('srv-res-service').value = '';

            document.getElementById('srv-res-date').value = new Date().toISOString().substring(0, 10);
            document.getElementById('srv-res-qty').value = 1;
            document.getElementById('srv-date-hint').textContent = '';

            // Configurar Autocomplete (Solo si no se ha configurado antes, o re-configurar es barato)
            // Idealmente esto se hace en init(), pero aqu√≠ aseguramos que los elementos existen.
            // Para evitar duplicar listeners, podemos verificar una flag o hacerlo idempotente.
            // Por simplicidad, lo haremos en init() y aqu√≠ solo limpiamos.

            modal.style.display = 'block';
        }

        async function loadClientActiveReservations(clientId) {
            const resSelect = document.getElementById('srv-res-id');

            if (!clientId) {
                resSelect.innerHTML = '<option value="">Seleccione un cliente primero</option>';
                resSelect.disabled = true;
                return;
            }

            resSelect.innerHTML = '<option value="">Cargando...</option>';
            resSelect.disabled = true;

            try {
                const resp = await fetchWithAuth(`/api/clients/${clientId}/active_reservations`);
                const reservations = await resp.json();

                resSelect.innerHTML = '<option value="">Seleccione una reserva...</option>';
                if (reservations.length > 0) {
                    reservations.forEach(r => {
                        const opt = document.createElement('option');
                        opt.value = r.reservation_id;
                        opt.textContent = `${r.reservation_code || 'R' + r.reservation_id} (${r.room_num}) - ${r.checkin_date} a ${r.checkout_date}`;
                        // Guardamos fechas en dataset para validaci√≥n UI
                        opt.dataset.start = r.checkin_date;
                        opt.dataset.end = r.checkout_date;
                        resSelect.appendChild(opt);
                    });
                    resSelect.disabled = false;
                } else {
                    resSelect.innerHTML = '<option value="">Sin reservas activas</option>';
                }
            } catch (e) {
                console.error(e);
                resSelect.innerHTML = '<option value="">Error al cargar</option>';
            }
        }

        // Listener para actualizar hint de fechas
        document.getElementById('srv-res-id').addEventListener('change', function () {
            const opt = this.options[this.selectedIndex];
            const hint = document.getElementById('srv-date-hint');
            if (opt && opt.dataset.start) {
                hint.textContent = `V√°lido entre ${opt.dataset.start} y ${opt.dataset.end}`;
                // Opcional: setear min/max en el input date
                document.getElementById('srv-res-date').min = opt.dataset.start;
                document.getElementById('srv-res-date').max = opt.dataset.end;
            } else {
                hint.textContent = '';
            }
        });

        async function submitServiceReservation() {
            const resId = document.getElementById('srv-res-id').value;
            const serviceId = document.getElementById('srv-res-service').value;
            const dateVal = document.getElementById('srv-res-date').value;
            const qty = document.getElementById('srv-res-qty').value;

            if (!resId || !serviceId || !dateVal || !qty) {
                alert('Todos los campos son obligatorios.');
                return;
            }

            const payload = {
                service_id: parseInt(serviceId),
                quantity: parseInt(qty),
                service_date: dateVal
            };

            try {
                const resp = await fetchWithAuth(`/api/reservations/${resId}/services`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const j = await resp.json();

                if (resp.ok) {
                    alert(j.message);
                    closeModal('serviceReservationModal');
                    renderReservationServices(); // Actualizar lista
                } else {
                    alert('Error: ' + j.error);
                }
            } catch (e) {
                alert('Error de conexi√≥n');
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>
