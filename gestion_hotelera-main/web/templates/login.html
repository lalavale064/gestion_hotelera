<!DOCTYPE html>
<html lang="es">
<!--
    NOTA: Parte del frontend fue generado con apoyo de herramientas de IA.
    Sin embargo, toda la lógica relacionada con base de datos, conexiones y operaciones CRUD
    fue implementada manualmente.
-->
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login - Hotel R&G</title>
  <style>
    /* ... ESTILOS OMITIDOS POR BREVEDAD ... */
    body {
      font-family: Arial, sans-serif;
      background: #f3f7f6;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .login-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      width: 320px;
    }

    input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button {
      width: 100%;
      padding: 10px;
      background: #2f9e65;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background: #258a55;
    }

    .hint {
      margin-top: 15px;
      font-size: 12px;
      color: #6b7280;
      text-align: center;
    }
  </style>
</head>

<body>

  <div class="login-card">
    <h2>Login - Hotel R&amp;G</h2>

    <input type="email" id="email" placeholder="Correo electrónico" required />
    <input type="password" id="password" placeholder="Contraseña" required />
    <button id="btnLogin">Iniciar Sesión</button>

    <div id="error" style="color: red; margin-top: 10px;"></div>
    <div class="hint">Usar credenciales de la base de datos (Ej: admin@hotel.com / admin)</div>

    <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
    <button id="btnToggleRegister" style="background: #6b7280;">Registrarse</button>
  </div>

  <div class="login-card" id="register-card" style="display: none;">
    <h2>Registro - Hotel R&amp;G</h2>
    <input type="text" id="reg-name" placeholder="Nombre Completo" required />
    <input type="email" id="reg-email" placeholder="Correo electrónico" required />
    <input type="tel" id="reg-phone" placeholder="Teléfono" />
    <input type="password" id="reg-password" placeholder="Contraseña" required />
    <button id="btnRegister">Crear Cuenta</button>
    <button id="btnCancelRegister" style="background: #6b7280; margin-top: 10px;">Cancelar</button>
    <div id="reg-error" style="color: red; margin-top: 10px;"></div>
  </div>

  <script>
    document.getElementById('btnLogin').addEventListener('click', login);
    document.getElementById('btnToggleRegister').addEventListener('click', toggleRegister);
    document.getElementById('btnCancelRegister').addEventListener('click', toggleRegister);
    document.getElementById('btnRegister').addEventListener('click', register);

    function toggleRegister() {
      const loginCard = document.querySelector('.login-card:not(#register-card)');
      const registerCard = document.getElementById('register-card');

      if (registerCard.style.display === 'none') {
        loginCard.style.display = 'none';
        registerCard.style.display = 'block';
      } else {
        loginCard.style.display = 'block';
        registerCard.style.display = 'none';
      }
    }

    async function register() {
      const name = document.getElementById('reg-name').value.trim();
      const email = document.getElementById('reg-email').value.trim();
      const phone = document.getElementById('reg-phone').value.trim();
      const password = document.getElementById('reg-password').value.trim();
      const error = document.getElementById('reg-error');
      error.textContent = '';

      if (!name || !email || !password) {
        error.textContent = 'Completa los campos obligatorios.';
        return;
      }

      try {
        const resp = await fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ full_name: name, email, phone, password })
        });

        const j = await resp.json();

        if (!resp.ok) {
          throw new Error(j.error || 'Error en el registro');
        }

        alert('Registro exitoso. Ahora puedes iniciar sesión.');
        toggleRegister();
        document.getElementById('email').value = email;
        document.getElementById('password').value = '';

      } catch (e) {
        error.textContent = e.message;
      }
    }

    async function login() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      const error = document.getElementById('error');
      error.textContent = '';

      if (!email || !password) { error.textContent = 'Completa todos los campos.'; return; }

      const body = new FormData();
      body.append('email', email);
      body.append('password', password);

      try {
        const resp = await fetch('/api/login', { method: 'POST', body });

        // Verificar si la respuesta es exitosa (200-299)
        if (!resp.ok) {
          // Intentar leer como JSON primero
          try {
            const errJson = await resp.json();
            throw new Error(errJson.error || 'Error en el servidor.');
          } catch (e) {
            // Si falla el JSON, probablemente sea HTML (404/500 del servidor web o proxy)
            if (resp.status === 404) {
              throw new Error('No se encontró el servidor de API (404). Asegúrate de ejecutar "python app.py" y acceder al puerto 5001.');
            }
            throw new Error(`Error del servidor: ${resp.status} ${resp.statusText}`);
          }
        }

        // Si es exitoso, procesar JSON
        const j = await resp.json();

        const role = j.role;
        localStorage.setItem('user_role', role);

        // Almacena client_id y redirige según el rol
        if (j.client_id) {
          localStorage.setItem('client_id', j.client_id);
        } else {
          localStorage.removeItem('client_id');
        }

        if (role === 'admin' || role === 'recepcion') {
          window.location.href = './administrador.html';
        } else if (role === 'spa') {
          window.location.href = './empleado.html';
        } else {
          // Cliente
          window.location.href = './cliente.html';
        }

      } catch (e) {
        // Mostrar el mensaje de error específico
        error.textContent = e.message;
        console.error(e);
      }
    }
  </script>
</body>

</html>
